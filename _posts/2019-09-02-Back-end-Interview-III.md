---
layout: post
title: 'Java后端面试整理（三）'
author: Marty Pang
categories: 
  - Interview
tags: 
  - Java
  - Back-End
last_modified_at: 2019-08-30T12:52:09-05:00
---

Java后端面试基础知识整理的第三部分主要针对数据库，特别是MySQL和Redis做一个总结。

* 目录
{:toc}


# 数据库系统原理

1. 什么是事务的ACID？
  - 原子性：事务被视为不可分割的最小单元，一个事务的所有操作要么全部成功要么全部失败回滚。回滚可以用undo log实现；
  - 一致性：事务对数据库的任何修改都必须满足定义好的规则（约束，级联，触发器等）；
  - 隔离性：指的是事物之间的执行互不干扰，一个事物所做的修改在提交前对其他事务是不可见的。
  - 持久性：一旦事务提交，其所做的修改会永远保存到数据库中，使用redo log保证持久性；

2. 常见的并发异常以及对应的隔离级别有哪些？
  - 丢失更新，这是所有数据库系统都不允许的并发异常，对应的隔离级别为未提交读；
  - 脏读，并发事务读取了其他事务未提交的更新，对应的隔离级别为可提交读；
  - 不可重复读，一个事务两次读取之间被别的事务修改了，对应的隔离级别为可重复读；
  - 幻读，主要针对插入删除操作，一个事务两次对某个范围的读取操作因为并发事务对该范围数据的插入或者删除导致结果不同，对应隔离级别为可串行化；

## 范式


## 分布式事务

1. 什么是2PC，3PC？分别存在什么问题？
2PC与3PC都能保证分布式事务的强一致性。
2PC增加事务协调者，对事务进行全局管理。第一阶段，协调者发出prepare命令，所有参与者接受指令后本地执行事务，写本地的redo和undo日志，但不提交。若不能成功准备贼返回终止；第二阶段，协调者收到所有确认回复后，如果都是ok，则发出commit命令，否则abort。参与者接收到commit消息后，提交事务，释放所有资源。
2PC存在的问题：
  - 同步阻塞，事务执行过程中，所有参与节点都是阻塞型的；
  - 单点故障，协调者是单点的；
  - 脑裂

# MySQL

## 索引

1. MySQL常见的索引类型有哪些？
  - 普通索引：alter table add index，没有任何限制；
  - 唯一索引：add unique，索引列的值必须唯一，允许有空值；
  - 主键索引：一种特殊的唯一索引，不允许有空值；
  - 全文索引：针对较大的字段；
  - 组合索引，建立多个列的索引，遵循最左前缀原则，应将最常用的列做限制条件放在最左边；

2. MySQL的索引结构？

   B+树索引数据只存在叶子节点，叶子节点添加顺序指针，支持范围查询；

   哈希索引查询效率非常高，不支持范围查询，哈希冲突需要全表扫描；

3. 有哪些数据结构可以作为索引结构？为什么MySQL选择了B+树，而不是B树或者红黑树？

   B树，B+树，红黑树。B+树多路索引，每层节点很多，降低了树高，红黑树树高较高，B+树能利用磁盘预读特性，相邻节点（页的大小）预先被载入，减少IO次数。B树内部节点存储数据，能存储的指针数变少。另一个原因，B+树叶子节点带顺序访问指针，支持range query，也提高了扫表的效率。

4. 解释以下最左匹配原则。

   利用联合索引最左的字段来构建B+树索引，查询时，首先匹配最左的字段。

5. 什么时候使用索引？
  - 经常出现在group by，order by和distinct关键字后面的字段；
  - 经常连接的表，在连接字段上建立索引；
  - 经常出现在where子句中的字段；
  - 经常用作查询选择的字段；

6. 主键索引和唯一索引的差别？
  - 主键索引一定会创建一个唯一索引，有唯一索引的列不一定是主键；
  - 主键不允许空值，唯一索引列允许空值；
  - 一张表只能有一个主键，但可以有多个唯一索引；
  - 主键可以被其它表引用位外键，唯一索引不可以；

7. 什么情况下索引会失效？查询不走索引？


8. 如何优化查询性能？


## 引擎

1. MySQL有哪些引擎？
  InnoDB、MyISAM、Memory、Archive等。
2. InnoDB和MyISAM的区别有哪些？
  - 事务支持：InnoDB支持事务，MyISAM不支持。InnoDB默认情况下开启autocommit，每一条SQL都会封装成事务；
  - 外键：InnoDB支持外键，MyISAM不支持，对于一个包含外键的InnoDB表转为MyISAM会失败；
  - 索引：InnoDB支持聚簇索引，每个表必须有主键，未指定主键的表默认生成一个主键，使用B+树作为索引结构，数据文件和主键索引绑定，而MyISAM非聚簇索引，支持无主键的表，存的是每一行记录的地址；MySQL5.7之后，InnoDB与MyISAM均支持全文索引；
  - 表锁差别：InnoDB支持表级锁和行级锁，MyISAM只支持表级锁；

3. InnoDB为什么推荐使用自增ID作为主键？
  使用自增ID可以保证每次插入时，B+树索引是从右边扩展的，这样可以避免B+树的频繁分裂和合并。

4. InnoDB的双写是怎么做的？为什么要双写？



## 扩展

### 分片

1. 为什么要分库分表？（设计高并发系统的时候，数据库层面该如何设计？）
  一开始可能用单机数据库就够了，随着请求增多，使用主从架构进行读写分离，master处理写请求，slave处理读请求，slave从master同步更新数据。但用户量级上来以后，写请求越来越多，一个master处理不过来，资源不够，这时候就需要分库分表，对写请求进行切分。具体来说分库分表有如下原因：
- 用户请求量太大，单服务器的内存，IO有限；
- 单个数据库太大，单个数据库处理能力有限，磁盘空间不足，造成IO瓶颈；
- 单表太大，CRUD成问题，索引膨胀，查询超时；

2. 如何设计分库分表？
  垂直切分：
- 垂直分表：大表拆小表，针对几百列的大表，把不常用的，数据较大的，长度较长（blob类型）的字段拆分到扩展表；
- 垂直分库：把多个依赖不强的表分到不同库中；
  水平切分：
- 水平分表：按某种规则，比如range，hash取模等，把一张表的记录切分到多张表里面去，这些表还在同一个库中；
- 水平分库分表：单张表数据水平切分到多个服务器上，规则可以是range、hash取模、地理区域、时间等；

3. 有哪些分库分表中间件？client方案和proxy方案各有什么优缺点？
  sharding-jdbc：client方式。
  mycat：proxy方式，通过定义表的分片规则来实现分片，每张表绑定一个分片规则，每个分片规则指定一个分片字段并绑定一个函数。
  client方式优点在于不用部署，运维成本低，不需要代理二次转发，性能高，缺点是耦合高，依赖sharding-jdbc；
  proxy优点，解耦和的，应用透明使用，缺点在于需要部署，维护一套中间件。
  无论什么模式，流程相似，SQL解析，重写，路由，执行，结果合并。

4. 分库分表后会面临哪些问题？
- 分布式事务，影响性能：2PC
- 跨节点的join操作：1）全局表，每个节点存一份；2）字段冗余，反范式设计；3）数据组装，分两次查询；4）ER分片，根据ER图，有关联的放在一个分片
- 跨界点order，limit，函数，各分片取出结果再做一次合并
- 全局主键，uuid，中心化的sequencer，snowflake分布式自增ID
- 数据迁移，扩容问题

### 复制

1. 主从复制的原理（流程）？
复制的前提，master数据库上开启了binlog。
   - master在事务提交之前，将操作记录写入binlog。
   - slave开启一个I/O thread，该线程在master打开一个连接，进行binlog dump流程，如果已经与master同步，则进入休眠状态等待master产生新的事件；该线程最终将操作记录写入中继日志中。
   - SQL线程读取中继日志，顺序执行该日志的SQL事件。
![](/images/20190902/masterslavecopy.png){.	:align-center}

2. MySQL的四种传统复制方式？
从数据同步方式的角度看，MySQL支持4中不同的同步方式：
  - 同步复制：master等待所有的slave复制完毕返回ack之后回复客户端，延迟太高，MySQL不采用；
  - 半同步复制：只需等待任意一个slave的回应，可设置超时，超时后自动降级位异步复制，网络延迟小可使用半同步复制；
  - 异步复制：即master执行完立即返回客户端，不管slave是否开始复制，问题在于slave复制过程中，master宕机，出现数据不一致；
  - 延迟复制：slave延迟一段时间再从master复制；

3. MySQL的读写分离怎么做的？
在多个服务器上部署mysql，将其中一台认为主数据库，而其他为从数据库，实现主从同步。其中主数据库负责主动写的操作，而从数据库则只负责主动读的操作（slave从数据库仍然会被动的进行写操作，为了保持数据一致性），这样就可以很大程度上的避免数据丢失的问题，同时也可减少数据库的连接，减轻主数据库的负载。


# Redis

1. 为什么使用redis？
主要考虑系统的性能和并发，一些热点数据，直接请求缓存，减少数据库的并发压力，缩短响应时间

2. Redis支持的对象数据类型，以及每种类型适用场景？
  - String
  - List
  - Hash
  - Set
  - 

3. Redis有哪些架构模式？各有什么特点？

4. Redis为什么使用单线程工作模型？为什么单线程这么快？

5. Redis的过期策略以及内存淘汰机制有哪些？

6. 什么是Redis持久化？Redis有哪几种持久化方式？优缺点是什么？

7. 使用缓存会有哪些问题？分别如何避免？